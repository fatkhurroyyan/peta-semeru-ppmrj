<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PETA SEMERU - Photobooth</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome untuk Ikon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts: Cinzel (Adventure Title) & Poppins (Body) -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Poppins:wght@300;400;600&display=swap"
    rel="stylesheet">
  <!-- JSZip untuk fitur Download Mentahan (ZIP) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- FileSaver untuk save file -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            deepForest: '#1A3C34', // Hijau Tua Gelap
            wood: '#D4A373',       // Coklat Muda Keemasan
            emerald: '#2D6A4F',    // Hijau Emerald
            mint: '#F0FDF4',       // Putih Kehijauan
          },
          fontFamily: {
            adventure: ['Cinzel', 'serif'],
            body: ['Poppins', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }

    /* Glass Panel dengan tint hijau sangat tipis */
    .glass-panel {
      background: rgba(26, 60, 52, 0.4);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(212, 163, 115, 0.3);
      /* Border warna Wood transparan */
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    /* Animasi Flash Kamera */
    @keyframes flash {
      0% {
        opacity: 1;
      }

      100% {
        opacity: 0;
      }
    }

    .flash-effect {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #F0FDF4;
      /* Flash warna Mint Cream */
      z-index: 50;
      pointer-events: none;
      animation: flash 0.8s ease-out forwards;
    }

    .hidden-canvas {
      display: none;
    }

    /* Fullscreen adjustments */
    :fullscreen #cameraContainer {
      width: 100vw;
      height: 100vh;
      max-width: none;
      border: none;
      border-radius: 0;
      background: #1A3C34;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      /* Indikator bisa diklik */
    }

    :fullscreen video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Custom Button Styles */
    .wood-btn {
      background-color: #D4A373;
      color: #1A3C34;
      transition: all 0.3s ease;
    }

    .wood-btn:hover {
      background-color: #c29260;
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }

    /* Layout Grid Buttons */
    .layout-btn {
      background: #2D6A4F;
      /* Emerald */
      border: 2px solid transparent;
      color: #F0FDF4;
    }

    .layout-btn:hover {
      background: #245841;
    }

    .layout-btn.active {
      background: #1A3C34;
      border: 2px solid #D4A373;
      /* Wood Border */
      color: #D4A373;
    }

    /* Background Pattern Hutan Abstrak (CSS Gradient) */
    .forest-bg {
      background: radial-gradient(circle at top right, #2D6A4F, #1A3C34 60%, #0f2520);
    }

    /* --- PRINT STYLES - KHUSUS A4 (8 STRIP LAYOUT) --- */
    #printArea {
      display: none;
    }

    @media print {
      @page {
        size: A4 portrait;
        /* Paksa Portrait */
        margin: 0;
        /* Hilangkan margin default browser */
      }

      body>* {
        display: none !important;
        /* Sembunyikan semua UI website */
      }

      #printArea {
        display: flex !important;
        flex-wrap: wrap;
        justify-content: center;
        align-content: flex-start;
        /* Rapikan ke atas */
        width: 210mm;
        /* Lebar A4 */
        height: 297mm;
        /* Tinggi A4 */
        background: white;
        padding: 5mm;
        /* Padding kertas sedikit */
        gap: 2mm;
        /* Jarak antar strip */
      }

      .print-item {
        /* Logika 8 Strip: 4 Kolom x 2 Baris */
        /* Lebar = (100% / 4) dikurangi gap */
        width: calc(25% - 2mm);
        height: auto;
        /* Tinggi menyesuaikan rasio */
        border: 1px dashed #ddd;
        /* Garis potong tipis */
        box-sizing: border-box;
      }
    }
  </style>
</head>

<body class="forest-bg min-h-screen text-mint overflow-x-hidden">

  <!-- Flash Overlay -->
  <div id="flash" class="hidden"></div>

  <!-- PRINT AREA (Hidden on Screen, Visible on Print) -->
  <div id="printArea">
    <!-- Content will be injected via JS -->
  </div>

  <div class="container mx-auto px-4 py-8 max-w-6xl relative z-10">

    <!-- Header -->
    <header class="text-center mb-10 relative">
      <!-- Dekorasi Daun -->
      <i
        class="fa-solid fa-leaf text-emerald absolute top-0 left-10 text-6xl opacity-20 transform -rotate-45 hidden md:block"></i>
      <i
        class="fa-solid fa-tree text-emerald absolute top-0 right-10 text-6xl opacity-20 transform rotate-12 hidden md:block"></i>

      <h1 class="text-5xl md:text-7xl font-adventure font-bold text-wood mb-2 tracking-wider drop-shadow-lg">
        <i class="fa-solid fa-compass mr-3 text-3xl align-middle opacity-80"></i>PETA SEMERU
      </h1>
      <div
        class="inline-block border-t border-b border-wood/30 py-2 px-6 bg-deepForest/50 backdrop-blur-sm rounded-full">
        <p class="text-mint text-sm md:text-lg font-light tracking-wide uppercase">
          PENGAJIAN AKHIR TAHUN <span class="text-wood font-bold">SE</span>mangat <span
            class="text-wood font-bold">ME</span>raih s<span class="text-wood font-bold">U</span>rga
        </p>
        <p class="text-xs text-emerald mt-1 font-bold">PPM Roudhotul Jannah Bandung</p>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

      <!-- Panel Kontrol (Kiri) -->
      <div class="lg:col-span-4 space-y-6">

        <!-- 1. Pilih Mode -->
        <div class="glass-panel p-6 rounded-2xl shadow-xl border-l-4 border-l-wood">
          <h2 class="text-xl font-bold mb-4 border-b border-wood/30 pb-2 text-wood font-adventure">
            <i class="fa-solid fa-map text-emerald mr-2"></i>1. Pilih Misi (Layout)
          </h2>
          <div class="grid grid-cols-1 gap-3">
            <!-- Mode 1 Foto -->
            <button onclick="setMode('story')" id="btnModestory"
              class="layout-btn p-3 rounded-xl transition flex items-center justify-between group">
              <div class="flex items-center gap-3">
                <div class="w-8 h-12 border-2 border-mint/30 rounded-sm bg-deepForest"></div>
                <div class="text-left">
                  <span class="block font-bold">1 Foto (Story)</span>
                  <span class="text-xs text-mint/70">1080 x 1920 px</span>
                </div>
              </div>
              <i class="fa-solid fa-location-dot opacity-0 transition text-wood"></i>
            </button>

            <!-- Mode 2 Foto -->
            <button onclick="setMode('poster')" id="btnModeposter"
              class="layout-btn p-3 rounded-xl transition flex items-center justify-between group">
              <div class="flex items-center gap-3">
                <div
                  class="w-8 h-10 border-2 border-mint/30 rounded-sm bg-deepForest flex flex-col justify-center gap-0.5 p-0.5">
                  <div class="h-1/2 bg-mint/10"></div>
                  <div class="h-1/2 bg-mint/10"></div>
                </div>
                <div class="text-left">
                  <span class="block font-bold">2 Foto (Poster)</span>
                  <span class="text-xs text-mint/70">1080 x 1440 px</span>
                </div>
              </div>
              <i class="fa-solid fa-location-dot opacity-0 transition text-wood"></i>
            </button>

            <!-- Mode 4 Foto (Strip) -->
            <button onclick="setMode('strip')" id="btnModestrip"
              class="layout-btn p-3 rounded-xl transition flex items-center justify-between group">
              <div class="flex items-center gap-3">
                <div
                  class="w-6 h-12 border-2 border-mint/30 rounded-sm bg-deepForest flex flex-col justify-between p-0.5">
                  <div class="h-1.5 bg-mint/10"></div>
                  <div class="h-1.5 bg-mint/10"></div>
                  <div class="h-1.5 bg-mint/10"></div>
                  <div class="h-1.5 bg-mint/10"></div>
                </div>
                <div class="text-left">
                  <span class="block font-bold">4 Foto (Strip)</span>
                  <span class="text-xs text-mint/70">1080 x 2880 px</span>
                </div>
              </div>
              <i class="fa-solid fa-location-dot opacity-0 transition text-wood"></i>
            </button>
          </div>
        </div>

        <!-- 2. Upload Frame -->
        <div class="glass-panel p-6 rounded-2xl shadow-xl border-l-4 border-l-wood">
          <h2 class="text-xl font-bold mb-4 border-b border-wood/30 pb-2 text-wood font-adventure">
            <i class="fa-solid fa-image text-emerald mr-2"></i>2. Upload Bingkai
          </h2>
          <p class="text-xs text-wood mb-3 font-semibold" id="resInfo">
            <i class="fa-solid fa-circle-info mr-1"></i> Pilih misi di atas terlebih dahulu.
          </p>

          <label id="uploadLabel"
            class="block w-full cursor-pointer bg-deepForest hover:bg-[#15302a] transition rounded-lg border-2 border-dashed border-emerald hover:border-wood p-4 text-center group relative overflow-hidden shadow-inner">
            <input type="file" id="frameInput" accept="image/png" class="hidden">
            <div id="uploadPlaceholder">
              <i class="fa-solid fa-tree text-3xl text-emerald group-hover:text-wood mb-2 transition"></i>
              <span class="block text-sm text-mint group-hover:text-wood font-medium" id="fileName">Pilih File PNG
                Transparan</span>
            </div>
          </label>

          <button id="btnDeleteFrame" onclick="removeFrame()"
            class="hidden w-full mt-3 bg-red-800/80 hover:bg-red-900 text-mint font-bold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2 border border-red-700">
            <i class="fa-solid fa-trash-can"></i> Hapus Bingkai
          </button>
        </div>

        <!-- 3. Instruksi -->
        <div class="glass-panel p-6 rounded-2xl shadow-xl bg-emerald/20 border-l-4 border-l-emerald">
          <h3 class="font-bold mb-2 text-wood font-adventure"><i class="fa-solid fa-campground mr-2"></i>Petunjuk
            Petualang:</h3>
          <ul class="text-sm text-mint/90 space-y-2 list-disc pl-4 marker:text-wood">
            <li><b>Shortcut Keyboard:</b> Tekan <span
                class="bg-wood text-deepForest px-1 rounded font-bold">SPASI</span> atau <span
                class="bg-wood text-deepForest px-1 rounded font-bold">ENTER</span> untuk ambil foto.</li>
            <li><b>Shortcut Mobile/Tablet:</b> Gunakan <span class="text-wood font-bold">Remote Bluetooth</span> atau
              sentuh layar.</li>
            <li>Pastikan background file PNG transparan.</li>
            <li>Mode Strip mendukung <b>Cetak A4 (8 Copies)</b>.</li>
          </ul>
        </div>
      </div>

      <!-- Area Kamera & Preview (Tengah & Kanan) -->
      <div class="lg:col-span-8 flex flex-col items-center">

        <!-- Wrapper Kamera -->
        <div id="cameraContainer" onclick="handleScreenTap()"
          class="relative w-full max-w-2xl bg-deepForest rounded-xl overflow-hidden shadow-2xl border-4 border-wood mb-6 group transition-all duration-300 aspect-video cursor-pointer">

          <!-- Dekorasi Sudut -->
          <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-wood z-20 pointer-events-none"></div>
          <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-wood z-20 pointer-events-none"></div>
          <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-wood z-20 pointer-events-none">
          </div>
          <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-wood z-20 pointer-events-none">
          </div>

          <!-- Overlay 'Tap to Capture' Hint -->
          <div
            class="absolute bottom-4 left-0 right-0 text-center z-30 opacity-0 group-hover:opacity-80 transition pointer-events-none">
            <span
              class="bg-deepForest/70 text-wood px-4 py-1 rounded-full text-xs font-adventure border border-wood/50">
              <i class="fa-solid fa-hand-pointer mr-1"></i> Klik/Sentuh Layar untuk Foto
            </span>
          </div>

          <!-- Tombol Fullscreen -->
          <button onclick="event.stopPropagation(); toggleFullscreen()"
            class="absolute top-4 right-4 z-30 bg-deepForest/60 hover:bg-deepForest text-wood p-3 rounded-full backdrop-blur-md transition opacity-0 group-hover:opacity-100 focus:opacity-100 border border-wood"
            title="Fullscreen Camera">
            <i id="fsIcon" class="fa-solid fa-expand text-xl"></i>
          </button>

          <!-- Video Feed -->
          <video id="webcam" autoplay playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>

          <!-- Overlay Countdown -->
          <div id="countdownDisplay"
            class="absolute inset-0 flex items-center justify-center bg-deepForest/80 text-9xl font-extrabold text-wood hidden z-10 font-adventure">
            3
          </div>

          <!-- Indikator Loading Kamera -->
          <div id="camLoading"
            class="absolute inset-0 flex flex-col items-center justify-center bg-deepForest text-mint z-0">
            <i class="fa-solid fa-compass fa-spin text-5xl mb-4 text-wood"></i>
            <p class="font-adventure tracking-widest text-wood">MENYIAPKAN LENSA...</p>
          </div>
        </div>

        <!-- Tombol Action Utama -->
        <div class="flex gap-4 mb-8">
          <button id="btnCapture" onclick="startPhotobooth()"
            class="wood-btn px-10 py-4 rounded-full font-bold text-xl shadow-xl flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed font-adventure tracking-wide">
            <i class="fa-solid fa-camera"></i> AMBIL FOTO (SPASI)
          </button>

          <button id="btnRetake" onclick="resetApp()"
            class="px-8 py-4 bg-emerald hover:bg-[#23533d] text-mint rounded-full font-bold text-lg shadow-xl hidden transition flex items-center gap-2 font-adventure border border-mint/20">
            <i class="fa-solid fa-rotate-left"></i> ULANG
          </button>
        </div>

        <!-- Area Hasil -->
        <div id="resultArea" class="hidden flex flex-col items-center animate-fade-in-up w-full">
          <h3 class="text-3xl font-bold mb-6 text-wood font-adventure drop-shadow-md">
            <i class="fa-solid fa-star text-mint mr-2"></i>HASIL PETUALANGAN
          </h3>

          <!-- Image Result Preview -->
          <img id="finalImage" class="rounded-lg shadow-2xl border-[6px] border-wood mb-6 h-auto"
            style="max-height: 50vh; max-width: 100%;" src="" alt="Hasil Photobooth">

          <!-- Action Buttons Container -->
          <div class="flex flex-col gap-3 w-full max-w-md">

            <!-- 1. Download Final Frame -->
            <a id="downloadLink" href="#" download="PETA_SEMERU_2025.png"
              class="wood-btn px-8 py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition text-lg w-full">
              <i class="fa-solid fa-download"></i> SIMPAN GAMBAR UTUH
            </a>

            <!-- 2. Download Mentahan (ZIP) -->
            <button onclick="downloadRawZip()"
              class="bg-emerald hover:bg-[#23533d] text-mint border border-mint/30 px-8 py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition w-full">
              <i class="fa-solid fa-file-zipper"></i> DOWNLOAD MENTAHAN (ZIP)
            </button>

            <!-- 3. Print A4 (Khusus Strip) -->
            <button id="btnPrintA4" onclick="printA4()"
              class="hidden bg-white text-deepForest hover:bg-gray-200 border border-gray-300 px-8 py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition w-full">
              <i class="fa-solid fa-print"></i> CETAK A4 (8 STRIP - HEMAT KERTAS)
            </button>

          </div>
        </div>

      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-mint/50 mt-12 pb-4 text-xs font-light">
      &copy; 2025 PPM Roudhotul Jannah Bandung | PETA SEMERU Photobooth System
    </footer>
  </div>

  <!-- Hidden Canvas untuk pemrosesan gambar -->
  <canvas id="photoCanvas" class="hidden-canvas"></canvas>

  <script>
    // --- KONFIGURASI KAMERA ---
    const config = {
      camWidth: 1920,
      camHeight: 1080,
      countdownTime: 3
    };

    // --- DEFINISI LAYOUT ---
    const layoutConfig = {
      'story': {
        name: "1 Foto (Story)",
        width: 1080,
        height: 1920,
        cols: 1,
        rows: 1,
        count: 1
      },
      'poster': {
        name: "2 Foto (Poster)",
        width: 1080,
        height: 1440,
        cols: 1,
        rows: 2,
        count: 2
      },
      'strip': {
        name: "4 Foto (Strip)",
        width: 1080,
        height: 2880,
        cols: 1,
        rows: 4,
        count: 4
      }
    };

    // --- STATE ---
    let state = {
      mode: 'poster',
      photos: [],      // Canvas mentah (tanpa frame)
      frameImage: null,
      isCapturing: false,
      finalDataURL: null // Menyimpan hasil akhir frame untuk keperluan print
    };

    // --- DOM ELEMENTS ---
    const webcamVideo = document.getElementById('webcam');
    const canvas = document.getElementById('photoCanvas');
    const ctx = canvas.getContext('2d');
    const countdownEl = document.getElementById('countdownDisplay');
    const resultArea = document.getElementById('resultArea');
    const finalImage = document.getElementById('finalImage');
    const btnCapture = document.getElementById('btnCapture');
    const btnRetake = document.getElementById('btnRetake');
    const flashEl = document.getElementById('flash');
    const frameInput = document.getElementById('frameInput');
    const camLoading = document.getElementById('camLoading');
    const btnDeleteFrame = document.getElementById('btnDeleteFrame');
    const fileNameLabel = document.getElementById('fileName');
    const cameraContainer = document.getElementById('cameraContainer');
    const fsIcon = document.getElementById('fsIcon');
    const resInfo = document.getElementById('resInfo');
    const btnPrintA4 = document.getElementById('btnPrintA4');

    // --- INIT CAMERA ---
    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: config.camWidth },
            height: { ideal: config.camHeight },
            facingMode: "user"
          },
          audio: false
        });
        webcamVideo.srcObject = stream;
        webcamVideo.onloadedmetadata = () => {
          camLoading.style.display = 'none';
        };
      } catch (err) {
        alert("Gagal mengakses kamera: " + err.message);
        camLoading.innerHTML = '<p class="text-red-500 font-bold">Kamera Belum Siap :(</p>';
      }
    }

    // --- UI FUNCTIONS ---

    function setMode(modeKey) {
      if (state.isCapturing) return;
      state.mode = modeKey;

      document.querySelectorAll('.layout-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.querySelector('i.fa-location-dot').classList.add('opacity-0');
      });
      const activeBtn = document.getElementById(`btnMode${modeKey}`);
      activeBtn.classList.add('active');
      activeBtn.querySelector('i.fa-location-dot').classList.remove('opacity-0');

      const layout = layoutConfig[modeKey];
      resInfo.innerHTML = `<i class="fa-solid fa-circle-info mr-1"></i> Mode: <b>${layout.name}</b>. Upload Bingkai Ukuran: <b>${layout.width}x${layout.height} px</b>`;
      resInfo.classList.remove('text-wood');
      resInfo.classList.add('text-mint');
    }

    frameInput.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        fileNameLabel.innerText = file.name;
        fileNameLabel.classList.add("text-wood", "font-bold");

        const reader = new FileReader();
        reader.onload = function (event) {
          const img = new Image();
          img.onload = () => {
            state.frameImage = img;
            btnDeleteFrame.classList.remove('hidden');

            const currentLayout = layoutConfig[state.mode];
            if (img.width !== currentLayout.width || img.height !== currentLayout.height) {
              alert(`Peringatan Petualang:\n\nUkuran bingkai (${img.width}x${img.height}) TIDAK SESUAI dengan misi yang dipilih (${currentLayout.width}x${currentLayout.height}).\n\nHasil mungkin akan gepeng!`);
            }
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    function removeFrame() {
      state.frameImage = null;
      frameInput.value = '';
      fileNameLabel.innerText = "Pilih File PNG Transparan";
      fileNameLabel.classList.remove("text-wood", "font-bold");
      btnDeleteFrame.classList.add('hidden');
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        cameraContainer.requestFullscreen().catch(err => alert(err.message));
        fsIcon.classList.replace('fa-expand', 'fa-compress');
      } else {
        document.exitFullscreen();
        fsIcon.classList.replace('fa-compress', 'fa-expand');
      }
    }

    // --- SHORTCUTS ---
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT') return;
      if (e.code === 'Space') e.preventDefault();
      if (['Space', 'Enter', 'AudioVolumeUp'].includes(e.code) || e.key === ' ' || e.key === 'Enter') {
        if (!state.isCapturing) startPhotobooth();
      }
    });

    function handleScreenTap() {
      if (!state.isCapturing) startPhotobooth();
    }

    // --- CORE LOGIC ---

    async function startPhotobooth() {
      if (state.isCapturing) return;

      const layout = layoutConfig[state.mode];
      state.isCapturing = true;
      state.photos = [];

      resultArea.classList.add('hidden');
      btnCapture.classList.add('hidden');

      for (let i = 1; i <= layout.count; i++) {
        await doCountdown(i);
        triggerFlash();
        const photoData = captureFrame();
        state.photos.push(photoData); // Simpan mentahan

        if (i < layout.count) {
          await new Promise(r => setTimeout(r, 1000));
        }
      }

      if (document.fullscreenElement) document.exitFullscreen();

      generateStrip();
      state.isCapturing = false;
      btnCapture.classList.remove('hidden');
      btnCapture.innerHTML = '<i class="fa-solid fa-camera"></i> AMBIL LAGI (SPASI)';
      btnRetake.classList.remove('hidden');
    }

    function doCountdown(num) {
      return new Promise(resolve => {
        let count = config.countdownTime;
        countdownEl.classList.remove('hidden');
        countdownEl.innerText = count;

        const timer = setInterval(() => {
          count--;
          if (count > 0) {
            countdownEl.innerText = count;
          } else {
            clearInterval(timer);
            countdownEl.classList.add('hidden');
            resolve();
          }
        }, 1000);
      });
    }

    function triggerFlash() {
      flashEl.classList.remove('hidden');
      flashEl.classList.add('flash-effect');
      setTimeout(() => {
        flashEl.classList.remove('flash-effect');
        flashEl.classList.add('hidden');
      }, 800);
    }

    function captureFrame() {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = webcamVideo.videoWidth;
      tempCanvas.height = webcamVideo.videoHeight;
      const tempCtx = tempCanvas.getContext('2d');

      tempCtx.translate(tempCanvas.width, 0);
      tempCtx.scale(-1, 1);
      tempCtx.drawImage(webcamVideo, 0, 0);

      return tempCanvas; // Mengembalikan canvas mentah
    }

    function generateStrip() {
      const layout = layoutConfig[state.mode];

      canvas.width = layout.width;
      canvas.height = layout.height;

      ctx.fillStyle = "#F0FDF4";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const slotWidth = canvas.width / layout.cols;
      const slotHeight = canvas.height / layout.rows;

      state.photos.forEach((photoCanvas, index) => {
        const col = index % layout.cols;
        const row = Math.floor(index / layout.cols);
        const xPos = col * slotWidth;
        const yPos = row * slotHeight;

        const slotRatio = slotWidth / slotHeight;
        const photoRatio = photoCanvas.width / photoCanvas.height;

        let drawW, drawH, drawX, drawY;

        if (photoRatio > slotRatio) {
          drawH = slotHeight;
          drawW = slotHeight * photoRatio;
          drawX = xPos - (drawW - slotWidth) / 2;
          drawY = yPos;
        } else {
          drawW = slotWidth;
          drawH = slotWidth / photoRatio;
          drawX = xPos;
          drawY = yPos - (drawH - slotHeight) / 2;
        }

        ctx.save();
        ctx.beginPath();
        ctx.rect(xPos, yPos, slotWidth, slotHeight);
        ctx.clip();
        ctx.drawImage(photoCanvas, drawX, drawY, drawW, drawH);
        ctx.restore();
      });

      // Frame & Watermark
      if (state.frameImage) {
        ctx.drawImage(state.frameImage, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = "#1A3C34";
        ctx.fillRect(0, canvas.height - 80, canvas.width, 80);
        ctx.fillStyle = "#D4A373";
        ctx.font = "bold 30px Cinzel";
        ctx.textAlign = "center";
        ctx.fillText("PETA SEMERU 2025 - PPM Roudhotul Jannah", canvas.width / 2, canvas.height - 30);
      }

      state.finalDataURL = canvas.toDataURL('image/png');
      finalImage.src = state.finalDataURL;
      resultArea.classList.remove('hidden');

      const link = document.getElementById('downloadLink');
      link.href = state.finalDataURL;

      resultArea.scrollIntoView({ behavior: 'smooth' });

      // Toggle Tombol Print A4 khusus mode Strip
      if (state.mode === 'strip') {
        btnPrintA4.classList.remove('hidden');
      } else {
        btnPrintA4.classList.add('hidden');
      }
    }

    function resetApp() {
      resultArea.classList.add('hidden');
      btnRetake.classList.add('hidden');
      btnCapture.innerHTML = '<i class="fa-solid fa-camera"></i> AMBIL FOTO (SPASI)';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- FITUR BARU: DOWNLOAD ZIP MENTAHAN ---
    function downloadRawZip() {
      const zip = new JSZip();
      const folder = zip.folder("PETA_SEMERU_RAW");

      // 1. Masukkan Foto Mentahan (Satu per satu)
      state.photos.forEach((canvas, i) => {
        const data = canvas.toDataURL("image/png").split(',')[1];
        folder.file(`foto_${i + 1}_mentah.png`, data, { base64: true });
      });

      // 2. Masukkan Hasil Akhir (Framed)
      if (state.finalDataURL) {
        const finalData = state.finalDataURL.split(',')[1];
        folder.file("hasil_photostrip_full.png", finalData, { base64: true });
      }

      zip.generateAsync({ type: "blob" }).then(function (content) {
        saveAs(content, "PETA_SEMERU_PAKET_FOTO.zip");
      });
    }

    // --- FITUR BARU: PRINT A4 (8 STRIP LAYOUT) ---
    function printA4() {
      if (state.mode !== 'strip') return;

      const printArea = document.getElementById('printArea');
      printArea.innerHTML = ''; // Clear previous

      // Buat 8 copy dari hasil final strip agar penuh 1 kertas A4
      for (let i = 0; i < 8; i++) {
        const img = document.createElement('img');
        img.src = state.finalDataURL;
        img.className = 'print-item';
        printArea.appendChild(img);
      }

      window.print();
    }

    setMode('poster');
    window.addEventListener('load', initCamera);

  </script>
</body>

</html>